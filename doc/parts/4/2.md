## SprocketsによるCSSの管理方法

Rails6.0以前まではフロントエンドで利用するパッケージ管理システムでしたが、Rails6.0以降はJavaScriptはWebpackerで管理するようになりました。

現在はCSSのみで利用されているパッケージングシステムです。


### Sprocketsの役割

SCSSなどをCSSへコンパイルしたり、複数あるファイルをリクエスト数を減らしてパフォーマンスをあげるために、1つにまとめたりする。いわゆるフロントエンド界隈で当たり前とされている機能を提供しています。


### ファイル構成

`app/assets/`配下に配置されています。それぞれの`application.xxx`をビルドするので、そのファイルで実装した数々のファイルを読み込むようにしてあげる必要があります。

```
This is a manifest file that'll be compiled into application.css, which will include all the files listed below.
 
 Any CSS and SCSS file within this directory, lib/assets/stylesheets, or any plugin's
 vendor/assets/stylesheets directory can be referenced here using a relative path.
 
 You're free to add application-wide styles to this file and they'll appear at the bottom of the
 compiled file so the styles you add here take precedence over styles defined in any other CSS/SCSS
 files in this directory. Styles in this file should be added after the last require_* statement.
 It is generally better to create a new file per style scope.

 # これは、以下にリストされているすべてのファイルを含む application.css にコンパイルされるマニフェスト ファイルです。
このディレクトリ、lib/assets/stylesheets、またはプラグインの vendor/assets/stylesheets ディレクトリ内の任意の CSS および SCSS ファイルは、相対パスを使用してここで参照できます。
このファイルにアプリケーション全体のスタイルを自由に追加できます。それらはコンパイルされたファイルの下部に表示されるため、ここで追加したスタイルは、このディレクトリ内の他の CSS/SCSS ファイルで定義されているスタイルよりも優先されます。このファイル内のスタイルは、最後の require_* ステートメントの後に追加する必要があります。
通常は、スタイル スコープごとに新しいファイルを作成する方が適切です。
```

`*= xxx`はSprocketsが解釈するための特別な記法となっています。**今回はCSSについて説明していますが、言語によりコメントアウトの方法が変わります。適宜読み替えてください。**

|  |  |
| --- | --- |
| *= require_tree | 引数で指定したディレクトリやサブディレクトリの全てのファイルを読み込みます。<br> *=require_tree ../stylesheets/ |
| *= require_directory | 指定されたディレクトリ内の全てのファイルを読み込みます。 |
| *= require_self | 自身の記載内容をいつ呼び出すかを決定できます。<br> 自身のファイル→requireしたファイル。などが可能 |
| *= require | 指定されたファイルを読み込みます。 |


### HTMLへの反映

`app/views/layouts/application.html.erb`などのレイアウトに以下を記載します

```
<%= stylesheet_link_tag 'application', media: 'all', 'data-turbolinks-track': 'reload' %>
```


### 本番への取り組み

本番環境では、ユーザーに待ち時間を与えないために、プリコンパイル(コンパイルされたCSSを配信)を行います。そのプリコンパイルを行うためのタスクが`assets:precompile`があります。

> 開発環境では`assets:precompile`を実行しなくても`app/assets`のソースコードはブラウザに反映されます。
あくまで本番環境時の取り組みであることに注意してください。

```
$ rails assets:precompile
```

タスクを実行すると、`public/assets`配下にいままでの`app/assets`配下で記載していたソースコードがコンパイルされて、出力されます。

minifyなどは、環境変数で本番を指定しないと実行されないので、注意してください。

また、本番環境にデプロイする場合、`rails asset:precompile`を明示的に実行する必要があります。そのため、デプロイのCI/CDで管理するのが望ましいです。


### 静的ファイルのデプロイ方法

JavaScriptやCSSなどの静的ファイルは、Railsが配信するのではなく、nginxなどのHTTPサーバーやCDNで配信する。という設計になっており、本番環境でpublic以下のディレクトリはnginxなどを利用するのが一般的になります。

しかし、`config/environments/production.rb`においてRailsが配信する方法もあります。

~~~~Ruby
# Disable serving static files from the `/public` folder by default since
# Apache or NGINX already handles this.
config.public_file_server.enabled = ENV['RAILS_SERVE_STATIC_FILES'].present?
~~~~
