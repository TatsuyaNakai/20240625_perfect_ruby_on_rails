## Stimulus

Turbolinksと併用できるもので、Turbolinksは手軽にユーザー体験をあげてくれますが、規約がないため、次第に可読性が下がってしまいます。

そこで**Stimulus**というライブラリを使用します。これは、DHHが所属するBasecamp社で開発されています。

### Stimulusの思想

フロントエンドに対して規約をもたらすためのフレームワークです。

HTML側で決められた属性名(data-controller...etc)を利用することで、Stimulusの規約に一致する名前のJavaScriptファイルに自動で紐づけられます。

結果として、HTMLを見ただけで、どのJavaScriptファイルに書かれた何のメソッドを実行するのかが理解できるようになります。

### インストール方法

Webpackerを利用している場合は、標準でRailsに組み込まれています。組み込まれていない場合は、以下コマンドを実行してください。

```
$ rails webpacker:install:stimulus
```

### 機能概要

`data-xxx`属性がStimulusで利用する属性になります。

1. 最も簡単なStimulus

  ~~~~Html
  <!-- hello_controller.jsを読み込みます。 -->
  <div data-controller='hello'>
    <!-- clickイベントで発火します -->
    <!-- hello_controllerにおけるgreetメソッドを実行します -->
    <button data-action='click->hello#greet'>Click me</button>
  </div>
  ~~~~

  ~~~~JavaScript
  // hello_controller.js
  import { Controller } from 'stimulus'

  export default class extends Controller {
    greet(){
      alert('hello, stimulus')
    }
  }
  ~~~~

2. DOM要素を指定して、少し複雑な処理をするStimulus

  ~~~~Html
  <!-- hello_controller.jsを読み込みます。 -->
  <div data-controller='hello'>
    <input data-target='hello.name' type='text'>
    <!-- clickイベントで発火します -->
    <!-- hello_controllerにおけるgreetメソッドを実行します -->
    <button data-action='click->hello#greet'>Greet</button>
  </div>
  <span data-target='hello.output'></span>
  ~~~~

  ~~~~JavaScript
  // hello_controller.js
  import { Controller } from 'stimulus'

  export default class extends COntroller {
    static targets = ['name', 'output']

    greet(){
      // static targetsの配列で値を定義したことで、nameTargetやoutputTargetを使用することができます。
      // また、data-targetで書かれたDOM要素と紐づいているため、DOMを変更できます。
      this.outputTarget.textContent = `Hello, ${this.nameTarget.value}`
    }
  }
  ~~~~


### 機能詳細


#### controller

HTMLにて`data-controller`を定義します。controllerは、必ずファイルを分けてあげ、ファイル名を対応させる必要があります。

1つのDOMに複数のcontrollerを紐づけることも可能です。その場合は複数のファイルを読み込みます。

同じHTMLファイルに同じ`data-controller`を複数回設定しても問題ありません。


#### action

イベントとコントローラー内のイベントを紐付けを行います。

`[イベントハンドラ]->[コントローラー名]#[メソッド名]`という規約をとります。HTMLの要素によってはイベントを省略することもできますが、明示的に書いてあげた方が親切かもしれません。

特定のDOMに紐づくため、`window`や`document`にイベントを紐付けたい場合は、以下のように記述してください。

~~~~Html
<!-- イベントハンドラの後に@xxと付けてください。 -->
<div data-controller='key' data-action='keypress@window->key#showkeyCode'>
  ...
</div>
~~~~

イベントから引数を受け取りたい場合は、JavaScript内のみの記述で取得できます

~~~~JavaScript
import { Controller } from 'stimulus'

export default class extends Controller {
  greet(event){
    alert(event.target.value)
  }
}
~~~~

一つのDOMに対して、複数のイベントを紐づけることができます。

~~~~Html
<!-- イベントごとにスペースであけてください。 -->
<input type='text' data-action='focus->form#highlight input->search#update' >
~~~~


#### target

HTMLにおける`data-controller`内の要素と、JavaScriptを関連づけています。

`[コントローラー名].[ターゲット名]`で定義します。

~~~~Html
<input type='text' data-target='hello.name' >
~~~~

static変数で`data-target`にて定義したターゲット名を配列で格納します。

~~~~JavaScript
// hello_controller.js
import { Controller } from 'stimulus'

export default class extends Controller {
  static targets = ['name'] // data-target='hello.name'が定義されている場合
  ...
}
~~~~

targetsで定義した時、クラス内で参照できるプロパティは以下の3つです

| プロパティ名 | 内容 |
| --- | --- |
| this.nameTarget | ターゲットにマッチするDOMのうち、先頭の1つ。<br>存在しなければエラーになります。 |
| this.nameTargets | ターゲットにマッチするDOMすべてを配列で返します。 |
| this.hasNameTarget | ターゲットにマッチするDOMが存在するかどうかをbooleanで返します。 |

一つのDOMに対して、複数のターゲットを紐づけることができます。

~~~~Html
<!-- ターゲットごとにスペースであけてください。 -->
<input type='text' data-target='hello.name bye.name' >
~~~~


#### Lifecycle Callback

DOM要素が出現した時や、消滅した時(ライフサイクル)のポイントで実行されるコールバックがあります。

| コールバック名 | 実行タイミング |
| --- | --- |
| initialize | `data-controller`で対象のJSファイルが読み込まれたとき |
| connect | 該当するコントローラーに紐づく要素が現れた時 |
| disconnect | 該当するコントローラーに紐づく要素が消えた時 |

ファイルが読み込まれるのは1度だけですが、出現や消滅はやりようによっては何度でも発生します。それぞれの使い勝手に適したものを選択してください。

~~~~JavaScript
import { Controller } from 'stimulus'

export default class extends COntroller {
  initialize(){
    ...
  }

  connect(){
    ...
  }

  disconnect(){
    ...
  }
}
~~~~


#### Data Maps

状態管理を行いたい時、data属性にて値を管理することができます。

`data-[コントローラー名]-[キー名]`として入力します。

~~~~Html
<div data-controller='content-loader' data-content-loader-url='/messages'>
  ...
</div>
~~~~

対象のJSファイルにて値を取得し、操作することができます。

~~~~JavaScript
import { Controller } from 'stimulus'

export default class extends COntroller {
  connect(){
    // this.dataにて取得することができます。
    console.log(this.data.get('url')) // /messages
  }
}
~~~~

取得のみならず、管理という事なので、他にもメソッドが存在します。

| メソッド名 | 内容 |
| --- | --- |
| this.data.get(key) | keyに対応する値を取得します。 |
| this.data.has(key) | データが存在していれば、trueを返します。 |
| this.data.set(key, value) | keyの値をvalueで設定します。 |
| this.data.delete(key) | keyに対応するデータを削除します。 |
