## 秘密情報を管理する

### Rails4.0まで

秘密情報を安全に管理する標準が定められていませんでした。そのため、`config/initializes/secret_token.rb`などに平文のまま記載されていました。

この問題から、秘密情報は環境変数経由で利用することが一般的になりましたが、これらのトークンは別リポジトリで管理するなどがされていました。


### Rails4.1

secrets.ymlの登場

~~~~Ruby
development:
  secret_key_base: ....
  hoge: ...
test:
  secret_key_base: ....
  hoge: ...
production:
  secret_key_base: ...
  hoge: ...
~~~~

上記の設定は、参照できるようになっていました。

```
Rails.application.secrets.secret_key_base
=> ....
```

この方針がRailsから提示されたけれど、`secrets.yml`は平文のままのため、別のリポジトリに本番環境の変数を置くか、平文のまま置いてしまうか(危ない...)を判断する必要があり、抜本的な解決にはなっていなかった。


### Rails5.1

encrypted secretsを使用した暗号化を行う。

`config/secrets.yml.enc`というファイルに暗号化した内容を記載することで、このファイルを同じリポジトリに保管する事ができるようになりました。

複合化するためには、キーを別で管理する必要はありますが、管理コストはすごく下がりました。

```
$ rails secrets:setup
=> Add this to your config/environments/production.rb:
config.read_encrypted_secrets = true
% Is - 1FA config/secrets.ymi* config/secrets.yml
config/secrets.yml.enc
config/secrets.yml.key # <-このファイルはコミットしないので、gitignore設定を行われる。
```

編集時には以下コマンドで秘密情報を編集します。

```
$ rails secrets:edit
```

さらに、`secrets.yml`から値を取得するためには、それぞれの環境にて、`config.read_encrypted_secrets = true`とする必要がありました。

以下コマンドで秘密情報を参照できます

~~~~Ruby
Rails.application.secrets.XXXX
=> ...
~~~~

トークン管理の複雑さが少しずつ低減されてきました。


### Rails5.2

Rails5.1で考えられた`secrets.yml`を使用したり、`secrets.yml.enc`を使用したり、`secret_key_base`の管理などで管理パターンが幾重にもなり、複雑になってきました。
そこで、**credentials**という仕組みを導入しました。

特徴は、環境変数ごとに値を切り替えない体制をとっている点になります。

credentialsで利用されるファイルと環境変数について
| | |
| --- | --- |
| config/credentials.yml.enc | 暗号化した設定ファイル |
| config/master.key | コミットしないファイル(デフォルトで.gitignoreに追加されている) |
| RAILS_MASTER_KEY | master.keyの値を環境変数経由で受け渡す場合の環境変数名 |

rails newで`secrets.yml`は生成されなくなり、`config/credentials.yml.enc`と`config/master.key`が生成されるようになりました。

`config/credentials.yml.enc`を編集するには、以前に近く、以下コマンドで編集/確認します。

```
# 編集時
$ rails credentials:edit

# 確認時
$ rails credentials:show
```

以下コマンドで秘密情報を参照できます

~~~~Ruby
Rails.application.credentials.XXXX
=> ...
~~~~


### Rails6.0

Rails5.2では、フラットさが特徴な故に、個別の環境にて環境変数を作成したい場合、スムーズに定義できない問題がありました。

Rails5.2の機能から、環境ごとの設定をできるようにオプションを追加しました。

```
# 編集方法
$ rails credentials:edit --environment test

# 確認方法
$ rails credentials:show --environment test
```

`--environment`で環境を設定することで、個別に環境を設定することができる。オプションを設定しない場合は、現在の環境より実行する。
