## RackとRailsの関係性

### Rackとは何か？

アプリケーションサーバーとアプリケーションを接続するための仕様であり、仕様を実装したライブラリもRackとして存在しています。
Webサーバー(※1)からHTTPリクエストを受け取り、アプリケーションサーバー(※2)に渡し、アプリケーション(※3)にリクエストを渡す際の、アプリケーションサーバーとアプリケーションの間に存在している。

※1: nginx,Apache<br>
※2: Puma, Sinatra (WEBrickはWebサーバーとしても、アプリケーションサーバーとしても機能する。)<br>
※3: Rails, Sinatra, Hanami

通信の全体像
![HTTPデータフローイメージ](/public/images/http-data-flow.png)

アプリケーションにおけるやりとり
![Appデータフローイメージ](/public/images/application-server-data-flow.png)

#### なぜRackが必要なのか？

Puma, UnicornなどのアプリケーションサーバーはRails専用ではなく、Sinatra, Hanamiなど他のアプリケーションにも対応している。
そのため、アプリケーションサーバーとアプリケーションの通信仕様を定める(インターフェースを標準化する)ことで、**どの組み合わせでも実装コストが必要ないです。**の状況を作りました。

参照記事

[Rack入門](https://qiita.com/nishio-dens/items/e293f15856d849d3862b)<br>
[What is Rack in Ruby?](https://medium.com/whynotio/what-is-rack-in-ruby-7e0615f1d9b6)

### Rackの動作について

少し複雑になるため、[別PR](https://github.com/TatsuyaNakai/rack-app)に記載

### RailsとRackの関係

RailsもRack仕様になっているアプリケーションのため、`config.ru`が存在する。
そのため、ミドルウェアを追加で定義することもできる。

#### ミドルウェアを独自で追加する方法

lib/middlewares 配下にRackミドルウェアとしての作法を遵守した定義を行う(initialize, call, callの返り値)

- 特定の環境だけで使用する場合

  config/enviroments/[適用したい環境].rb にてrequiredにてファイルを記載

- 全ての環境で使用する場合

  config/application.rb にてrequiredにてファイルを記載

この方法の場合は、ミドルウェアをアプリケーションの直前に定義されることになります。
もし特定のミドルウェアの手前や直後に実行したい場合は、[Railsガイド](https://railsguides.jp/rails_on_rack.html#%E3%83%9F%E3%83%89%E3%83%AB%E3%82%A6%E3%82%A7%E3%82%A2%E3%82%B9%E3%82%BF%E3%83%83%E3%82%AF%E3%82%92%E8%A8%AD%E5%AE%9A%E3%81%99%E3%82%8B)に記載してあります。