## ActiveJobによる非同期実行

メール送信や、大量にデータが存在するCSVファイルの処理などで利用されています。

時間がかかる処理については、先にレスポンスを返しておき、非同期処理で別途実行することで、ユーザーを待たせることがなくすことができます。


### ジョブの実装

ジョブクラスを作成する場合、以下のコマンドにて必要なファイルを生成することができます。

```
$ rails g job [モデル名]
```

~~~~Ruby
class [モデル名]Job < ApplicationJob
  queue_as :default

  def perform(*args)
    # 処理したい内容を記載します。
  end
end
~~~~

~~~~Ruby
# 直後に実行したい場合
XXXJob.perform_later

# タイミング指定
XXXJob.set(wait: 1.minute)
~~~~

アダプターがデフォルトの場合、プロセスが切れると、キューも消滅してしまうので注意してください。


### アダプターにSidekiqを使用する

~~~~Ruby
# Gemfile
gem 'sidekiq'

# config/application.rb
...
config.active_job.queue_adapter = :sidekiq
~~~~

Sidekiqを利用する場合、redisが必要になります。Docker環境の場合は、redisを追加してあげてください。

SidekiqがRedisサーバーに接続するための設定を行います。

~~~~Ruby
redis_config = { url: 'redis://redis:6379/0' }

Sidekiq.configure_server do |config|
  config.redis = redis_config
end

Sidekiq.configure_client do |config|
  config.redis = redis_config
end
~~~~

Sidekiqは、キューの状態を確認するUIが提供されています。もし、本番環境でも利用する場合は、アクセス制限をすることを忘れないようにしてください。

~~~~Ruby
if Rails.env.development?
  require 'sidekiq/web'

  mount Sidekiq::Web => '/sidekiq'
end
~~~~


### 複数のキューを管理する

非同期実行したい処理ごとにキューを分けることで、全体の把握がしやすくなります。また、重要なものとそうでないものを別々に管理することができます。

~~~~Ruby
class [モデル名]Job < ApplicationJob
  queue_as :hoge # キューをdefaultから分けています。

  def perform(*args)
    # 処理したい内容を記載します。
  end
end
~~~~

別で管理するためには、設定を書く必要があります。`default`に加えて、`hoge`が必要になったことを`config/sidekiq.yml`に記載します。

~~~~yml
:queues:
  - default
  - hoge
  ...
~~~~


### 例外処理

ジョブの実行時に発生した例外をリトライするための`retry_on`とジョブを取りやめる`discard_on`があります。

#### リトライ

引数に発生した例外クラスのケースを指定して、その後にオプションを記載します。これはAsyncアダプターでもSidekiqでも用意されています。

~~~~Ruby
class [モデル名]Job < ApplicationJob
  queue_as :default

  retry_on StandardError, ZeroDivisionError, wait: 5.seconds, attempts: 3

  def perform(*args)
    ...
  end
end
~~~~

| オプション名 | 概要 | デフォルト値 |
| --- | --- | --- |
| wait | 次回までのインターバル | 3.seconds |
| attempts | リトライ回数 | 5 |
| queue | リトライ時に追加するqueue | nil |
| priority | 優先度 | nil |


#### 破棄

引数に発生した例外クラスのケースを指定しますが、`retry_on`と違いオプションはありません。

~~~~Ruby
class [モデル名]Job < ApplicationJob
  queue_as :default

  discard_on StandardError, ZeroDivisionError

  def perform(*args)
    ...
  end
end
~~~~


### テスト

`test/jobs`ディレクトリにテストを記載します。

~~~~Ruby
require 'test_helper'
class [モデル名]JobTest < ActiveJob::TestCase
  test 'Enqueue [モデル名]Job' do
    ...
  end
end
~~~~

1. ジョブにキューが追加されるか
2. ジョブの結果でレコードが追加/削除が実施されたかどうか

`perform_enqueued_jobs`を実行すると、キューに追加されたジョブを即時実行できます。